-- CHECK WHEN DBCC CHECKDB LAST RUN SUCCESSFULLY


CREATE TABLE #TBL_DBCC_STATUS(
    [DB NAME] NVARCHAR(MAX),
    [LAST SUCCESSFULL DBCC DATE] NVARCHAR(MAX)
);

-- DROP TABLE #TBL_DBCC_STATUS


DECLARE @SQL NVARCHAR(1000);

DECLARE @DB_NAME NVARCHAR(MAX);

DECLARE CURSOR_TABLE CURSOR
	FOR 
		(SELECT 
			[NAME]
		FROM
  			SYS. DATABASES AS DB );

OPEN CURSOR_TABLE




FETCH NEXT FROM CURSOR_TABLE INTO 
	@DB_NAME;



WHILE @@FETCH_STATUS = 0
    BEGIN
		PRINT 'CHEKING DB:';
		PRINT @DB_NAME;

		--USE ' + @DB_NAME + ' 
		SET @SQL = N'
						INSERT INTO #TBL_DBCC_STATUS
						SELECT (SELECT '''+ @DB_NAME +''') AS DB_NAME, CONVERT(NVARCHAR(MAX) ,  CONVERT(VARCHAR, DATABASEPROPERTYEX (N''' + @DB_NAME + ''', N''LASTGOODCHECKDBTIME''), 20) );
					' ;

		EXECUTE  SP_EXECUTESQL @SQL;
	
        FETCH NEXT FROM CURSOR_TABLE INTO 
			@DB_NAME;
    END;

CLOSE CURSOR_TABLE;
DEALLOCATE CURSOR_TABLE;

SELECT 
	 [DB NAME]
	,CASE
		WHEN [LAST SUCCESSFULL DBCC DATE] = '1900-01-01 00:00:00'
		THEN 'NEVER'
		ELSE [LAST SUCCESSFULL DBCC DATE]			
	END AS [LAST SUCCESSFULL DBCC DATE]
FROM #TBL_DBCC_STATUS