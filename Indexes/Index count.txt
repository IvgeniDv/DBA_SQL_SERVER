-- MIGHT BE HEAVY TO RUN ON LARGE DB'S

IF EXISTS (SELECT * FROM MSDB.SYS.OBJECTS WHERE [NAME] = 'INDEXCOUNT')
    DROP TABLE MSDB.DBO.INDEXCOUNT;
GO
CREATE TABLE MSDB.DBO.INDEXCOUNT (
	SCHEMAID INT,
	OBJECTID INT,
    BASETYPE CHAR (10),
    INDEXCOUNT SMALLINT);
GO 

EXEC SP_MSFOREACHDB 
    N'IF EXISTS (SELECT 1 FROM (SELECT DISTINCT [NAME] 
    FROM SYS.DATABASES WHERE [STATE_DESC] = ''ONLINE''
        ) AS NAMES WHERE [NAME] = ''?'')
BEGIN
USE [?]
INSERT INTO MSDB.DBO.INDEXCOUNT
SELECT O.[SCHEMA_ID], O.[OBJECT_ID], ''HEAP'', 0
FROM SYS.OBJECTS O
WHERE O.[TYPE_DESC] IN (''USER_TABLE'', ''VIEW'')
    AND O.[IS_MS_SHIPPED] = 0
    AND EXISTS (
        SELECT *
        FROM SYS.INDEXES
        WHERE [INDEX_ID] = 0
            AND [OBJECT_ID] = O.[OBJECT_ID]);

INSERT INTO MSDB.DBO.INDEXCOUNT
SELECT O.[SCHEMA_ID], O.[OBJECT_ID], ''CLUSTERED'', 0
FROM SYS.OBJECTS O
WHERE O.[TYPE_DESC] IN (''USER_TABLE'', ''VIEW'')
    AND O.[IS_MS_SHIPPED] = 0
    AND EXISTS (
        SELECT *
        FROM SYS.INDEXES
        WHERE [INDEX_ID] = 1
            AND [OBJECT_ID] = O.[OBJECT_ID]);

UPDATE MSDB.DBO.INDEXCOUNT
SET [INDEXCOUNT] = (
	SELECT COUNT (*) 
	FROM SYS.INDEXES I
	WHERE I.OBJECT_ID = [OBJECTID]
	AND I.[IS_HYPOTHETICAL] = 0);

IF EXISTS (SELECT * FROM MSDB.DBO.INDEXCOUNT)
SELECT
	''?'' AS [DATABASE],
	SCHEMA_NAME ([SCHEMAID]) AS [SCHEMA],
	OBJECT_NAME ([OBJECTID]) AS [TABLE],
	[BASETYPE],
	(CASE
		WHEN [INDEXCOUNT] = 0 THEN 0
		ELSE [INDEXCOUNT]-1 END)
	AS [NCINDEXES]
FROM MSDB.DBO.INDEXCOUNT
ORDER BY [BASETYPE] DESC, INDEXCOUNT;

TRUNCATE TABLE MSDB.DBO.INDEXCOUNT;
END';
GO 

DROP TABLE MSDB.DBO.INDEXCOUNT;
GO
